{# apps/dashboard/templates/dashboard/index.html #}
{% extends 'dashboard_base.html' %}
{% block title %}MLOps Dashboard{% endblock %}
{% block sidebar %}
<div class="sidebar shadow-sm">
    <h5 class="mb-3 text-dark">ëª¨ë¸ ëª©ë¡</h5>
    <div class="list-group">
        <a href="#model-v1" class="list-group-item list-group-item-action active">
            Iris Classifier v1.2 <span class="badge badge-success float-right">ë°°í¬</span>
        </a>
        <a href="#model-v2" class="list-group-item list-group-item-action">
            Iris Classifier v2.0 <span class="badge badge-warning float-right">ì¤€ë¹„</span>
        </a>
        <a href="#model-legacy" class="list-group-item list-group-item-action">
            Legacy Model <span class="badge badge-danger float-right">íê¸°</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action text-primary">
            + ìƒˆ ëª¨ë¸ ë“±ë¡
        </a>
    </div>
    <hr>
    <h6 class="mt-4 text-secondary">ì£¼ìš” ê¸°ëŠ¥</h6>
    <ul class="list-unstyled">
        <li><a href="#" class="text-dark">ì‹¤í—˜ ê´€ë¦¬</a></li>
        <li><a href="#" class="text-dark">ë°ì´í„° ê´€ë¦¬</a></li>
        <li><a href="#" class="text-dark">ì•Œë¦¼ ì„¤ì •</a></li>
    </ul>
</div>
{% endblock %}
{% block content %}
<h1 class="mb-4">ì„ íƒëœ ëª¨ë¸ ìƒì„¸ ì •ë³´ ë° ê´€ë¦¬: Iris Classifier v1.2</h1>
<div class="card shadow-sm">
    <div class="card-header p-0">
        <ul class="nav nav-tabs" id="modelTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab">ê°œìš”</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="performance-tab" data-toggle="tab" href="#performance" role="tab">ì„±ëŠ¥</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="data-tab" data-toggle="tab" href="#data" role="tab">ë°ì´í„°</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="deployment-tab" data-toggle="tab" href="#deployment" role="tab">ë°°í¬</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="log-tab" data-toggle="tab" href="#log" role="tab">ë¡œê·¸</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="settings-tab" data-toggle="tab" href="#settings" role="tab">ì„¤ì •</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="modelTabContent">
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title text-primary">ëª¨ë¸ ê¸°ë³¸ ì •ë³´</h5>
                                <p><strong>ë²„ì „:</strong> v1.2</p>
                                <p><strong>ë°°í¬ ìƒíƒœ:</strong> <span class="badge badge-success">Active</span></p>
                                <p><strong>í•™ìŠµì¼:</strong> 2025-09-28</p>
                                <p><strong>ìµœì¢… ì—…ë°ì´íŠ¸:</strong> 2025-09-29</p>
                                <p><strong>ì•Œê³ ë¦¬ì¦˜:</strong> Scikit-learn Logistic Regression</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">ì˜ˆì¸¡ ê²°ê³¼ ëª¨ë‹ˆí„°ë§ (ì‹œê°„ ì¶”ì´)</h5>
                                <canvas id="predictionMonitorChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ (ë”ë¯¸)</h5>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <h6 class="mb-0">CPU ì‚¬ìš©ëŸ‰</h6>
                                        <div class="progress" style="height: 20px;">
                                            <div id="cpu_usage_bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <h6 class="mb-0">ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰</h6>
                                        <div class="progress" style="height: 20px;">
                                            <div id="mem_usage_bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
                <div class="row">
                    <div class="col-lg-3 col-md-4">
                        <div id="performance_metrics" class="p-2 border rounded bg-light mb-3">
                            <h6 class="text-info">ì£¼ìš” ì§€í‘œ</h6>
                            <p><strong>Accuracy:</strong> <span id="accuracy_metric">...</span></p>
                            <p><strong>F1 Score:</strong> <span id="f1_score_metric">...</span></p>
                            <p><strong>Macro-AUC:</strong> <span id="macro_auc_metric">...</span></p>
                            <p><strong>Micro-AUC:</strong> <span id="micro_auc_metric">...</span></p>
                        </div>
                        <div id="anomaly_alerts" class="list-group">
                            <h6 class="text-danger">ì´ìƒ ê°ì§€ ì•Œë¦¼</h6>
                            <div class="alert alert-info py-1" role="alert">
                                ì´ìƒ ê°ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9 col-md-8">
                        <ul class="nav nav-pills mb-3" id="perfSubTab" role="tablist">
                            <li class="nav-item"><a class="nav-link active" id="roc-tab" data-toggle="tab" href="#roc" role="tab">ROC Curve</a></li>
                            <li class="nav-item"><a class="nav-link" id="cm-tab" data-toggle="tab" href="#cm" role="tab">Confusion Matrix</a></li>
                            <li class="nav-item"><a class="nav-link" id="pr-tab" data-toggle="tab" href="#pr" role="tab">PR Curve</a></li>
                        </ul>
                        <div class="tab-content" id="perfSubTabContent">
                            <div class="tab-pane fade show active" id="roc" role="tabpanel"><canvas id="rocChart" class="mt-3" style="max-height: 400px;"></canvas></div>
                            <div class="tab-pane fade" id="cm" role="tabpanel"><div id="confusion_matrix_container" class="mt-3"></div></div>
                            <div class="tab-pane fade" id="pr" role="tabpanel"><canvas id="prChart" class="mt-3" style="max-height: 400px;"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
                <h5 class="card-title text-warning">ë°ì´í„° ë“œë¦¬í”„íŠ¸ ê°ì§€</h5>
                <div id="drift_status" class="mb-3">
                    <div class="alert alert-info py-1"><strong>ë°ì´í„° ë“œë¦¬í”„íŠ¸ ìƒíƒœë¥¼ ë¡œë“œ ì¤‘...</strong></div>
                </div>

                <h6 class="mt-4">íŠ¹ì„±ë³„ ë“œë¦¬í”„íŠ¸ ìƒì„¸</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-hover feature-table">
                        <thead>
                            <tr>
                                <th>íŠ¹ì„± ì´ë¦„</th>
                                <th>p-value (ë“œë¦¬í”„íŠ¸ ì§€í‘œ)</th>
                                <th>ìƒíƒœ</th>
                                <th>ë©”ì‹œì§€</th>
                                <th>ë¶„í¬</th>
                            </tr>
                        </thead>
                        <tbody id="drift_feature_tbody">
                            </tbody>
                    </table>
                </div>

                <hr>
                <h5 id="current-drift-plot-title" class="selected-feature-plot-title mt-4">ë¶„í¬ í”Œë¡¯ì„ ë³´ë ¤ë©´ íŠ¹ì„±ì„ ì„ íƒí•˜ì„¸ìš”.</h5>
                <div class="card shadow-sm mt-3">
                    <div class="card-body p-2">
                        <div id="drift_chart_container" style="height: 400px; width: 100%;">
                            <p class="text-muted text-center pt-5" id="plot-message">íŠ¹ì„± ì˜†ì˜ 'ë¶„í¬ ë³´ê¸°'ë¥¼ í´ë¦­í•˜ì—¬ ë¶„í¬ ì°¨íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="deployment" role="tabpanel" aria-labelledby="deployment-tab">
                <h5 class="card-title text-success">ëª¨ë¸ ì¬í•™ìŠµ & ë°°í¬ ê´€ë¦¬</h5>
                <p>ëª¨ë¸ ì„±ëŠ¥ ì €í•˜ ë° ì‹ ê·œ ë°ì´í„° ìœ ì… ì‹œ ì¬í•™ìŠµ/ë°°í¬/ë¡¤ë°±ì„ ì§ì ‘ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.</p>
                <form action="{{ url_for('dashboard.trigger_retrain') }}" method="post" class="d-inline mr-2">
                    <button type="submit" class="btn btn-warning btn-lg">ëª¨ë¸ ì¬í•™ìŠµ</button>
                </form>
                <form action="{{ url_for('dashboard.deploy_model') }}" method="post" class="d-inline mr-2">
                    <button type="submit" class="btn btn-primary btn-lg">ëª¨ë¸ ë°°í¬</button>
                </form>
                <form action="{{ url_for('dashboard.rollback_model') }}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger btn-lg">ëª¨ë¸ ë¡¤ë°±</button>
                </form>
                <hr>
                <h6>ë°°í¬ íˆìŠ¤í† ë¦¬ (ë”ë¯¸)</h6>
                <ul class="list-group">
                    <li class="list-group-item list-group-item-success">v1.2 ë°°í¬ ì™„ë£Œ (2025-09-29 10:30)</li>
                    <li class="list-group-item list-group-item-info">v1.1 ë¡¤ë°± (2025-09-25 15:45)</li>
                    <li class="list-group-item">v1.1 ë°°í¬ ì™„ë£Œ (2025-09-25 10:00)</li>
                </ul>
            </div>

            <div class="tab-pane fade" id="log" role="tabpanel" aria-labelledby="log-tab">
                <h5 class="card-title text-secondary">ìš´ì˜ ë¡œê·¸</h5>
                <pre class="bg-dark text-white p-3 rounded" style="max-height: 400px; overflow-y: scroll;">
[2025-09-29 17:00:01] INFO: Prediction request processed successfully. (200 OK)
[2025-09-29 16:55:34] WARNING: Data drift detected in 'sepal_length'. p-value: 0.045
[2025-09-29 16:50:11] ERROR: Database connection failed during logging. Retrying...
[2025-09-29 10:30:00] DEPLOY: Model v1.2 deployed to production endpoint.
[2025-09-28 23:59:59] TRAIN: Retraining job finished. New model v1.2 saved. Accuracy: 0.98
                </pre>
            </div>

             <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <h5 class="card-title text-secondary">ëª¨ë¸ ì„¤ì •</h5>
                <form>
                    <div class="form-group">
                        <label for="threshold">ë¶„ë¥˜ ì„ê³„ê°’</label>
                        <input type="number" step="0.01" class="form-control" id="threshold" value="0.5" required>
                    </div>
                    <div class="form-group">
                        <label for="drift_alpha">ë“œë¦¬í”„íŠ¸ ê°ì§€ ìœ ì˜ ìˆ˜ì¤€ (Alpha)</label>
                        <input type="number" step="0.001" class="form-control" id="drift_alpha" value="0.05" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ì„¤ì • ì €ì¥</button>
                </form>
            </div>
            
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // í´ë˜ìŠ¤ ì´ë¦„ì— ë”°ë¥¸ ìƒ‰ìƒ ë§¤í•‘ í•¨ìˆ˜
        function get_color_by_class(className) {
            const colors = {
                'setosa': 'rgb(255, 99, 132)',
                'versicolor': 'rgb(54, 162, 235)',
                'virginica': 'rgb(75, 192, 192)',
            };
            return colors[className] || 'rgb(128, 128, 128)';
        }

        // ëª¨ë“  ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤
        
        // --- 1. AI ëª¨ë¸ ì„±ëŠ¥ ì‹œê°í™” (Performance íƒ­) ---
        async function fetchPerformanceData() {
            try {
                const response = await fetch("{{ url_for('dashboard.model_performance') }}");
                const data = await response.json();
                
                // ì§€í‘œ ì—…ë°ì´íŠ¸
                document.getElementById('accuracy_metric').innerText = data.metrics.accuracy;
                document.getElementById('f1_score_metric').innerText = data.metrics.f1_score;
                document.getElementById('macro_auc_metric').innerText = data.metrics.auc_roc_macro.toFixed(4);
                document.getElementById('micro_auc_metric').innerText = data.metrics.auc_roc_micro.toFixed(4);
                
                // ROC Curve
                const rocCtx = document.getElementById('rocChart').getContext('2d');
                const rocDatasets = [];
                for (const className in data.roc_data.fpr) {
                    const color = get_color_by_class(className);
                    rocDatasets.push({
                        label: `ROC (${className}) AUC: ${data.roc_data.auc[className].toFixed(2)}`,
                        data: data.roc_data.tpr[className].map((tpr, i) => ({x: data.roc_data.fpr[className][i], y: tpr})),
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 2,
                        fill: false
                    });
                }
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ íŒŒê´´ í›„ ì¬ìƒì„± (íƒ­ ì „í™˜ ì‹œ ì¬ì‹œê°í™” ì˜¤ë¥˜ ë°©ì§€)
                if (window.rocChartInstance) window.rocChartInstance.destroy();
                window.rocChartInstance = new Chart(rocCtx, {
                    type: 'line',
                    data: { datasets: rocDatasets },
                    options: { responsive: true, aspectRatio: 1, scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'False Positive Rate' } }, y: { title: { display: true, text: 'True Positive Rate' } } } }
                });

                // PR Curve
                const prCtx = document.getElementById('prChart').getContext('2d');
                const prDatasets = [];
                for (const className in data.pr_data.precision) {
                    const color = get_color_by_class(className);
                    prDatasets.push({
                        label: `PR (${className}) AUC: ${data.pr_data.auc[className].toFixed(2)}`,
                        data: data.pr_data.precision[className].map((precision, i) => ({x: data.pr_data.recall[className][i], y: precision})),
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 2,
                        fill: false
                    });
                }
                if (window.prChartInstance) window.prChartInstance.destroy();
                window.prChartInstance = new Chart(prCtx, {
                    type: 'line',
                    data: { datasets: prDatasets },
                    options: { responsive: true, aspectRatio: 1, scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Recall' } }, y: { title: { display: true, text: 'Precision' } } } }
                });

                // í˜¼ë™ í–‰ë ¬ í…Œì´ë¸” ìƒì„±
                const cmData = data.confusion_matrix;
                if (cmData && cmData.matrix.length > 0) {
                    const cmContainer = document.getElementById('confusion_matrix_container');
                    cmContainer.innerHTML = '';
                    const table = document.createElement('table');
                    table.className = 'table table-bordered text-center';
                    
                    const thead = table.createTHead();
                    const headerRow = thead.insertRow();
                    headerRow.innerHTML = '<th></th>'; 
                    cmData.labels.forEach(label => {
                        const th = document.createElement('th');
                        th.innerText = `ì˜ˆì¸¡: ${label}`;
                        headerRow.appendChild(th);
                    });
                    
                    const tbody = table.createTBody();
                    cmData.matrix.forEach((row, i) => {
                        const tr = tbody.insertRow();
                        const rowHeader = document.createElement('th');
                        rowHeader.innerText = `ì‹¤ì œ: ${cmData.labels[i]}`;
                        tr.appendChild(rowHeader);
                        row.forEach((cell, j) => {
                            const td = document.createElement('td');
                            td.innerText = cell;
                            td.classList.add(i === j ? 'table-success' : 'table-danger');
                            tr.appendChild(td);
                        });
                    });
                    cmContainer.appendChild(table);
                }

            } catch (error) {
                console.error("Error fetching performance data:", error);
                document.getElementById('performance_metrics').innerHTML = `<p class="text-danger">ëª¨ë¸ ì„±ëŠ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }
        
        // ìƒˆë¡œìš´: ê°œë³„ íŠ¹ì„±ì˜ ë¶„í¬ í”Œë¡¯ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function showDriftPlot(featureName, featureData) {
            const plotContainer = document.getElementById('drift_chart_container');
            const plotTitle = document.getElementById('current-drift-plot-title');
            const plotMessage = document.getElementById('plot-message');
            // ì´ì „ ì°¨íŠ¸ ì‚­ì œ
            Plotly.purge(plotContainer.id); 
            plotMessage.style.display = 'none';

            plotTitle.textContent = `ğŸ“Š ${featureName} ë¶„í¬ ë¹„êµ`;
            const traceRef = { 
                x: featureData.reference, 
                name: 'ê¸°ì¤€ ë°ì´í„° (ê³¼ê±°)', 
                type: 'histogram', 
                opacity: 0.6, 
                marker: { color: 'rgba(54, 162, 235, 1)' } // íŒŒë€ìƒ‰
            };
            const traceCurr = { 
                x: featureData.current, 
                name: 'ìµœê·¼ ë°ì´í„° (í˜„ì¬)', 
                type: 'histogram', 
                opacity: 0.6, 
                marker: { color: 'rgba(255, 99, 132, 1)' } // ë¹¨ê°„ìƒ‰
            };
            const layout = { 
                barmode: 'overlay', 
                title: `<b>${featureName}</b> ë¶„í¬ ë³€í™”`, 
                xaxis: { title: featureName, automargin: true }, 
                yaxis: { title: 'ë¹ˆë„', automargin: true }, 
                margin: { t: 50, r: 10, b: 50, l: 40 }, 
                responsive: true 
            };
            // ì°¨íŠ¸ ìƒì„±
            Plotly.newPlot(plotContainer.id, [traceRef, traceCurr], layout, {responsive: true});
        }
        window.showDriftPlot = showDriftPlot; // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ

        // --- 2. ë°ì´í„° ë“œë¦¬í”„íŠ¸ ì‹œê°í™” (Data íƒ­) ---
        async function fetchDataDriftData() {
            try {
                const response = await fetch("{{ url_for('dashboard.data_drift') }}");
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                const driftStatus = document.getElementById('drift_status');
                const driftTbody = document.getElementById('drift_feature_tbody');
                const plotMessage = document.getElementById('plot-message');

                driftTbody.innerHTML = ''; // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ì´ˆê¸°í™”
                driftStatus.innerHTML = '';
                plotMessage.style.display = 'block'; 
                
                let driftCount = 0;
                let featuresPopulated = false;

                if (Object.keys(data.drift_results).length === 0) {
                    driftStatus.innerHTML = `<div class="alert alert-info py-1"><strong>ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ ë“œë¦¬í”„íŠ¸ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong></div>`;
                    return;
                }

                // 1. ì „ì²´ ìš”ì•½ ìƒíƒœ ì—…ë°ì´íŠ¸
                for (const feature in data.drift_results) {
                    if (data.drift_results[feature].drift_detected === 1) {
                        driftCount++;
                    }
                }

                const overallStatusMessage = driftCount > 0 
                    ? `<div class="alert alert-danger py-1"><strong>ğŸš¨ ì´ ${driftCount}ê°œì˜ íŠ¹ì„±ì—ì„œ ë°ì´í„° ë“œë¦¬í”„íŠ¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¬í•™ìŠµì„ ê³ ë ¤í•˜ì„¸ìš”.</strong></div>`
                    : `<div class="alert alert-success py-1"><strong>âœ… ëª¨ë“  íŠ¹ì„±ì—ì„œ ë°ì´í„° ë“œë¦¬í”„íŠ¸ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</strong></div>`;
                
                driftStatus.innerHTML = overallStatusMessage;

                // 2. íŠ¹ì„±ë³„ ìƒì„¸ í…Œì´ë¸” ì±„ìš°ê¸°
                const dataDriftData = data.drift_data; // í”Œë¡¯ì„ ìœ„í•´ ë°ì´í„° ë¶„ë¦¬
                
                for (const feature in data.drift_results) {
                    featuresPopulated = true;
                    const result = data.drift_results[feature];
                    const isDriftDetected = result.drift_detected === 1;
                    const statusText = isDriftDetected ? 'Drift Detected' : 'No Drift';
                    const statusClass = isDriftDetected ? 'text-danger' : 'text-success';

                    const row = driftTbody.insertRow();
                    // JSON.stringify ê²°ê³¼ë¥¼ HTML ì†ì„±ì— ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì¹˜í™˜
                    const featureDataJson = JSON.stringify(dataDriftData[feature]).replace(/"/g, '&quot;');
                    
                    row.innerHTML = `
                        <td>${feature}</td>
                        <td>${result.p_value.toFixed(5)}</td>
                        <td class="${statusClass} font-weight-bold">${statusText}</td>
                        <td>${result.message}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="window.showDriftPlot('${feature}', ${featureDataJson})">
                                ë¶„í¬ ë³´ê¸°
                            </button>
                        </td>
                    `;
                }

                if (!featuresPopulated) {
                    driftTbody.innerHTML = '<tr><td colspan="5" class="text-center">ë¶„ì„í•  íŠ¹ì„± ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }

            } catch (error) {
                console.error("Error fetching drift data:", error);
                document.getElementById('drift_status').innerHTML = `<div class="alert alert-danger">ë°ì´í„° ë“œë¦¬í”„íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì˜¤ë¥˜: ${error.message}</div>`;
                document.getElementById('drift_feature_tbody').innerHTML = '<tr><td colspan="5" class="text-danger text-center">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
            }
        }
        
        // --- 3. ì˜ˆì¸¡ ê²°ê³¼ ëª¨ë‹ˆí„°ë§ ì‹œê°í™” (Overview íƒ­) ---
        async function fetchPredictionMonitorData() {
            try {
                const response = await fetch("{{ url_for('dashboard.prediction_monitor') }}");
                const data = await response.json();
                
                const ctx = document.getElementById('predictionMonitorChart').getContext('2d');
                if (window.predictionMonitorChartInstance) window.predictionMonitorChartInstance.destroy();
                window.predictionMonitorChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: data.data,
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' }, title: { display: true, text: 'ì‹œê°„ì— ë”°ë¥¸ ì˜ˆì¸¡ ê²°ê³¼ ë¶„í¬' } },
                        scales: { x: { type: 'category' }, y: { stacked: true, title: { display: true, text: 'ì˜ˆì¸¡ ê±´ìˆ˜' } } }
                    }
                });
            } catch (error) {
                console.error("Error fetching prediction monitor data:", error);
                const container = document.getElementById('predictionMonitorChart').parentElement;
                container.innerHTML = `<div class="alert alert-danger">ì˜ˆì¸¡ ëª¨ë‹ˆí„°ë§ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // --- 4. ì´ìƒ ê°ì§€ ë° ì•Œë¦¼ (Performance íƒ­) ---
        async function fetchAnomalyData() {
            try {
                const response = await fetch("{{ url_for('dashboard.anomaly_detection') }}");
                const data = await response.json();
                
                const alertsContainer = document.getElementById('anomaly_alerts');
                alertsContainer.innerHTML = '<h6 class="text-danger">ì´ìƒ ê°ì§€ ì•Œë¦¼</h6>';
                
                if (data.anomalies.length > 0) {
                    data.anomalies.forEach(anomaly => {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-danger py-2 mb-1';
                        alert.innerHTML = `<strong>ì´ìƒ ê°ì§€!</strong> ID: #${anomaly.id} (${anomaly.predicted_class})`;
                        alertsContainer.appendChild(alert);
                    });
                } else {
                    alertsContainer.innerHTML += `<div class="alert alert-success py-1">ì´ìƒ ë°ì´í„° ì—†ìŒ.</div>`;
                }
            } catch (error) {
                console.error("Error fetching anomaly data:", error);
                document.getElementById('anomaly_alerts').innerHTML = `<div class="alert alert-warning py-1">ì´ìƒ ê°ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // --- 5. ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ (ë”ë¯¸) (Overview íƒ­) ---
        function updateResourceUsage() {
            const cpuUsage = Math.floor(Math.random() * 50) + 30; // 30-80%
            const memUsage = Math.floor(Math.random() * 40) + 50; // 50-90%
            
            const cpuBar = document.getElementById('cpu_usage_bar');
            cpuBar.style.width = cpuUsage + '%';
            cpuBar.innerText = cpuUsage + '%';
            
            const memBar = document.getElementById('mem_usage_bar');
            memBar.style.width = memUsage + '%';
            memBar.innerText = memUsage + '%';
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë”© (Overview íƒ­ì˜ ë°ì´í„°ë§Œ ë¡œë“œ)
        fetchPredictionMonitorData();
        updateResourceUsage();

        // íƒ­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ì—¬ íƒ­ì„ í´ë¦­í•  ë•Œ í•´ë‹¹ íƒ­ì˜ ë°ì´í„°ë§Œ ë¡œë“œí•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            const target = $(e.target).attr("href"); // í™œì„±í™”ëœ íƒ­
            
            if (target === '#performance') {
                fetchPerformanceData();
                fetchAnomalyData();
            } else if (target === '#data') {
                fetchDataDriftData();
            } else if (target === '#overview') {
                fetchPredictionMonitorData();
                updateResourceUsage();
            }
        });
        
        // ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì€ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        setInterval(updateResourceUsage, 5000);
    });
</script>
{% endblock %}